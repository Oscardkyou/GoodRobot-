<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Детали мастера - GoodRobot Admin</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
</head>
<body>
    {% include 'base.html' %}

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1>Детали мастера</h1>
            <a href="/masters" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Назад к списку</a>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Основная информация</h5>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">{{ master.full_name }}</h5>
                        <p class="card-text"><strong>ID:</strong> {{ master.id }}</p>
                        <p class="card-text"><strong>Username:</strong> {{ master.username }}</p>
                        <p class="card-text"><strong>Телефон:</strong> {{ master.phone }}</p>
                        <p class="card-text"><strong>Telegram ID:</strong> {{ master.telegram_id }}</p>
                        <p class="card-text"><strong>Статус:</strong> 
                            {% if master.is_active %}
                            <span class="badge bg-success">Активен</span>
                            {% else %}
                            <span class="badge bg-danger">Заблокирован</span>
                            {% endif %}
                        </p>
                        <p class="card-text"><strong>Дата регистрации:</strong> {{ master.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                        <div class="mt-3">
                            {% if master.is_active %}
                            <a href="#" onclick="confirmAction('/api/masters/{{ master.id }}/block', 'Вы уверены, что хотите заблокировать этого мастера?')" class="btn btn-danger">Заблокировать</a>
                            {% else %}
                            <a href="#" onclick="confirmAction('/api/masters/{{ master.id }}/unblock', 'Вы уверены, что хотите разблокировать этого мастера?')" class="btn btn-success">Разблокировать</a>
                            {% endif %}
                            <a href="#" onclick="confirmAction('/api/masters/{{ master.id }}', 'Вы уверены, что хотите удалить этого мастера?', 'DELETE')" class="btn btn-danger">Удалить</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Специальности мастера</h5>
                    </div>
                    <div class="card-body">
                        <form id="specialties-form">
                            <div class="mb-3">
                                <label for="master-specialties" class="form-label">Выберите специальности</label>
                                <select class="form-select" id="master-specialties" multiple>
                                    {% for specialty in all_specialties %}
                                    <option value="{{ specialty.id }}" {% if specialty in master.specialties %}selected{% endif %}>{{ specialty.name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Выберите одну или несколько специальностей для мастера</div>
                            </div>
                            <button type="button" id="save-specialties" class="btn btn-primary">Сохранить специальности</button>
                        </form>
                        
                        <div class="mt-4">
                            <h6>Текущие специальности:</h6>
                            <ul class="list-group">
                                {% if master.specialties %}
                                {% for specialty in master.specialties %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    {{ specialty.name }}
                                    <span class="badge bg-primary rounded-pill">ID: {{ specialty.id }}</span>
                                </li>
                                {% endfor %}
                                {% else %}
                                <li class="list-group-item text-muted">У мастера нет специальностей</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Категории заказов</h5>
                    </div>
                    <div class="card-body">
                        <form id="categories-form">
                            <div class="mb-3">
                                <label for="master-categories" class="form-label">Выберите категории заказов</label>
                                <select class="form-select" id="master-categories" multiple>
                                    {% for category in all_categories %}
                                    <option value="{{ category }}" {% if category in master_categories %}selected{% endif %}>{{ category }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Выберите одну или несколько категорий заказов для мастера</div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <button type="button" id="save-categories" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Сохранить категории
                                </button>
                                <div id="categories-feedback" class="text-success" style="display: none;">
                                    <i class="bi bi-check-circle-fill"></i> Категории успешно сохранены
                                </div>
                            </div>
                        </form>
                        
                        <div class="mt-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">Текущие категории заказов:</h6>
                                <span class="badge bg-primary" id="categories-count">{{ master_categories|length }}</span>
                            </div>
                            <div class="categories-container">
                                {% if master_categories %}
                                <div class="row">
                                    {% for category in master_categories %}
                                    <div class="col-md-6 mb-2">
                                        <div class="card border-success">
                                            <div class="card-body p-2 d-flex justify-content-between align-items-center">
                                                <span><i class="bi bi-check-circle-fill text-success me-2"></i>{{ category }}</span>
                                                <span class="badge bg-success">Активна</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    У мастера нет выбранных категорий заказов
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Статистика заказов</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h3>{{ master_stats.completed_orders|default(0) }}</h3>
                                        <p class="mb-0">Выполнено заказов</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h3>{{ master_stats.active_orders|default(0) }}</h3>
                                        <p class="mb-0">Активных заказов</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/custom.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            // Добавляем Bootstrap Icons в head
            if (!$('link[href*="bootstrap-icons"]').length) {
                $('head').append('<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">');
            }
            
            // Инициализация Select2 для множественного выбора специальностей
            $('#master-specialties').select2({
                placeholder: 'Выберите специальности',
                allowClear: true,
                theme: 'bootstrap-5'
            });
            
            // Инициализация Select2 для множественного выбора категорий
            $('#master-categories').select2({
                placeholder: 'Выберите категории заказов',
                allowClear: true,
                theme: 'bootstrap-5',
                templateResult: formatCategoryOption,
                templateSelection: formatCategorySelection
            });
            
            // Форматирование опций категорий
            function formatCategoryOption(category) {
                if (!category.id) return category.text;
                return $('<span><i class="bi bi-tag me-2"></i>' + category.text + '</span>');
            }
            
            // Форматирование выбранных категорий
            function formatCategorySelection(category) {
                if (!category.id) return category.text;
                return $('<span><i class="bi bi-check2 me-1"></i>' + category.text + '</span>');
            }
            
            // Обработчик для сохранения специальностей
            $('#save-specialties').click(function() {
                const specialtyIds = $('#master-specialties').val();
                const saveBtn = $(this);
                
                // Проверка на пустой выбор
                if (!specialtyIds || specialtyIds.length === 0) {
                    if (!$('#specialties-warning').length) {
                        $('<div id="specialties-warning" class="alert alert-warning mt-2">Выберите хотя бы одну специальность</div>')
                            .insertAfter(saveBtn)
                            .fadeIn();
                        setTimeout(() => $('#specialties-warning').fadeOut('slow', function() { $(this).remove(); }), 3000);
                    }
                    return;
                }
                
                // Показываем индикатор загрузки
                saveBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Сохранение...');
                
                fetch('/api/masters/{{ master.id }}/specialties', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        specialty_ids: specialtyIds.map(id => parseInt(id))
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка при сохранении специальностей');
                    }
                    return response.json();
                })
                .then(data => {
                    // Показываем сообщение об успехе
                    saveBtn.removeClass('btn-primary').addClass('btn-success')
                        .html('<i class="bi bi-check-circle"></i> Сохранено');
                    
                    // Через 1.5 секунды перезагружаем страницу
                    setTimeout(() => location.reload(), 1500);
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    saveBtn.removeClass('btn-primary').addClass('btn-danger')
                        .html('<i class="bi bi-exclamation-triangle"></i> Ошибка');
                    setTimeout(() => {
                        saveBtn.removeClass('btn-danger').addClass('btn-primary')
                            .prop('disabled', false)
                            .html('<i class="bi bi-save"></i> Сохранить специальности');
                    }, 2000);
                });
            });
            
            // Обработчик для сохранения категорий
            $('#save-categories').click(function() {
                const categories = $('#master-categories').val();
                const saveBtn = $(this);
                const feedbackEl = $('#categories-feedback');
                
                // Проверка на пустой выбор
                if (!categories || categories.length === 0) {
                    if (!$('#categories-warning').length) {
                        $('<div id="categories-warning" class="alert alert-warning mt-2">Выберите хотя бы одну категорию</div>')
                            .insertAfter(saveBtn.parent())
                            .fadeIn();
                        setTimeout(() => $('#categories-warning').fadeOut('slow', function() { $(this).remove(); }), 3000);
                    }
                    return;
                }
                
                // Показываем индикатор загрузки
                saveBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Сохранение...');
                
                fetch('/api/masters/{{ master.id }}/categories', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        categories: categories
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка при сохранении категорий');
                    }
                    return response.json();
                })
                .then(data => {
                    // Показываем сообщение об успехе
                    saveBtn.removeClass('btn-primary').addClass('btn-success')
                        .html('<i class="bi bi-check-circle"></i> Сохранено');
                    
                    // Показываем сообщение об успехе
                    feedbackEl.fadeIn('slow');
                    
                    // Через 1.5 секунды перезагружаем страницу
                    setTimeout(() => location.reload(), 1500);
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    saveBtn.removeClass('btn-primary').addClass('btn-danger')
                        .html('<i class="bi bi-exclamation-triangle"></i> Ошибка');
                    setTimeout(() => {
                        saveBtn.removeClass('btn-danger').addClass('btn-primary')
                            .prop('disabled', false)
                            .html('<i class="bi bi-save"></i> Сохранить категории');
                    }, 2000);
                });
            });
        });
    </script>
</body>
</html>
