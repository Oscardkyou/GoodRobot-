{% extends "base.html" %}

{% block title %}Аналитика{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Аналитика</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshBtn">
                    <i class="bi bi-arrow-clockwise"></i> Обновить
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="exportBtn">
                    <i class="bi bi-download"></i> Экспорт
                </button>
            </div>
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="periodDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-calendar3"></i> Период
                </button>
                <ul class="dropdown-menu" aria-labelledby="periodDropdown">
                    <li><a class="dropdown-item period-option" data-period="month" href="#">Месяц</a></li>
                    <li><a class="dropdown-item period-option" data-period="quarter" href="#">Квартал</a></li>
                    <li><a class="dropdown-item period-option" data-period="year" href="#">Год</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Основные показатели -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Пользователи</h5>
                    <h2 class="card-text" id="totalUsers">-</h2>
                    <div class="small text-muted">Всего пользователей</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Заказы</h5>
                    <h2 class="card-text" id="totalOrders">-</h2>
                    <div class="small text-muted">Всего заказов</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Активные заказы</h5>
                    <h2 class="card-text" id="activeOrders">-</h2>
                    <div class="small text-muted">Заказов в работе</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Средний чек</h5>
                    <h2 class="card-text" id="averageOrderPrice">-</h2>
                    <div class="small text-muted">Средняя стоимость заказа</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Графики -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    Рост пользователей
                </div>
                <div class="card-body">
                    <canvas id="userGrowthChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    Статистика заказов
                </div>
                <div class="card-body">
                    <canvas id="orderStatisticsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    Статистика ставок
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="bidStatusChart"></canvas>
                        </div>
                        <div class="col-md-6">
                            <h5>Топ мастеров по принятым ставкам</h5>
                            <ul class="list-group" id="topMastersList">
                                <!-- Список будет заполнен через JavaScript -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    Статистика выплат
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="payoutStatusChart"></canvas>
                        </div>
                        <div class="col-md-6">
                            <canvas id="payoutAmountChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Доходы и расходы -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    Доходы и расходы
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Общий доход</h5>
                                    <h2 class="card-text text-success" id="totalRevenue">-</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Общие расходы</h5>
                                    <h2 class="card-text text-danger" id="totalExpenses">-</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Прибыль</h5>
                                    <h2 class="card-text" id="totalProfit">-</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Распределение пользователей по ролям -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    Распределение пользователей по ролям
                </div>
                <div class="card-body">
                    <canvas id="userRolesChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    Статусы заказов
                </div>
                <div class="card-body">
                    <canvas id="orderStatusChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    // Глобальные переменные
    let currentPeriod = 'month';
    let charts = {};
    
    // Цвета для графиков
    const colors = {
        blue: 'rgba(54, 162, 235, 0.7)',
        green: 'rgba(75, 192, 192, 0.7)',
        red: 'rgba(255, 99, 132, 0.7)',
        yellow: 'rgba(255, 206, 86, 0.7)',
        purple: 'rgba(153, 102, 255, 0.7)',
        orange: 'rgba(255, 159, 64, 0.7)',
        grey: 'rgba(201, 203, 207, 0.7)'
    };
    
    // Загрузка данных при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        loadStatistics();
        loadUserGrowth();
        loadOrderStatistics();
        loadBidStatistics();
        loadPayoutStatistics();
        loadRevenueStatistics(currentPeriod);
        
        // Обработчики событий
        document.getElementById('refreshBtn').addEventListener('click', refreshAllData);
        document.getElementById('exportBtn').addEventListener('click', exportAnalytics);
        
        // Обработчики для выбора периода
        document.querySelectorAll('.period-option').forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                currentPeriod = this.getAttribute('data-period');
                document.getElementById('periodDropdown').textContent = getPeriodText(currentPeriod);
                loadRevenueStatistics(currentPeriod);
            });
        });
    });
    
    // Получение текстового представления периода
    function getPeriodText(period) {
        switch (period) {
            case 'month': return 'Месяц';
            case 'quarter': return 'Квартал';
            case 'year': return 'Год';
            default: return 'Период';
        }
    }
    
    // Обновление всех данных
    function refreshAllData() {
        loadStatistics();
        loadUserGrowth();
        loadOrderStatistics();
        loadBidStatistics();
        loadPayoutStatistics();
        loadRevenueStatistics(currentPeriod);
        showToast('Данные обновлены', 'success');
    }
    
    // Загрузка основной статистики
    function loadStatistics() {
        fetch('/analytics/api/statistics')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка при загрузке данных');
                }
                return response.json();
            })
            .then(data => {
                // Обновляем основные показатели
                document.getElementById('totalUsers').textContent = data.total_users;
                document.getElementById('totalOrders').textContent = data.total_orders;
                document.getElementById('activeOrders').textContent = data.active_orders;
                document.getElementById('averageOrderPrice').textContent = data.average_order_price.toFixed(2);
                
                // Создаем график распределения пользователей по ролям
                createUserRolesChart(data.users_by_role);
            })
            .catch(error => {
                console.error('Ошибка:', error);
                showToast('Ошибка при загрузке статистики', 'danger');
            });
    }
    
    // Создание графика распределения пользователей по ролям
    function createUserRolesChart(usersData) {
        const ctx = document.getElementById('userRolesChart').getContext('2d');
        
        // Если график уже существует, уничтожаем его
        if (charts.userRoles) {
            charts.userRoles.destroy();
        }
        
        // Подготавливаем данные
        const labels = [];
        const data = [];
        const backgroundColors = [colors.blue, colors.green, colors.red, colors.yellow];
        
        usersData.forEach((item, index) => {
            let roleLabel = '';
            switch (item.role) {
                case 'client': roleLabel = 'Клиенты'; break;
                case 'master': roleLabel = 'Мастера'; break;
                case 'admin': roleLabel = 'Администраторы'; break;
                case 'partner': roleLabel = 'Партнеры'; break;
                default: roleLabel = item.role;
            }
            labels.push(roleLabel);
            data.push(item.count);
        });
        
        // Создаем график
        charts.userRoles = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Распределение пользователей по ролям'
                    }
                }
            }
        });
    }
    
    // Загрузка данных о росте пользователей
    function loadUserGrowth() {
        fetch('/analytics/api/user-growth')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка при загрузке данных');
                }
                return response.json();
            })
            .then(data => {
                createUserGrowthChart(data);
            })
            .catch(error => {
                console.error('Ошибка:', error);
                showToast('Ошибка при загрузке данных о росте пользователей', 'danger');
            });
    }
    
    // Создание графика роста пользователей
    function createUserGrowthChart(growthData) {
        const ctx = document.getElementById('userGrowthChart').getContext('2d');
        
        // Если график уже существует, уничтожаем его
        if (charts.userGrowth) {
            charts.userGrowth.destroy();
        }
        
        // Подготавливаем данные
        const labels = growthData.map(item => item.date);
        const data = growthData.map(item => item.count);
        
        // Создаем график
        charts.userGrowth = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Новые пользователи',
                    data: data,
                    backgroundColor: colors.blue,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: 'Динамика регистрации новых пользователей'
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Дата'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Количество новых пользователей'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Загрузка статистики заказов
    function loadOrderStatistics() {
        fetch('/analytics/api/order-statistics')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка при загрузке данных');
                }
                return response.json();
            })
            .then(data => {
                createOrderStatisticsChart(data.daily_orders);
                createOrderStatusChart(data.status_statistics);
            })
            .catch(error => {
                console.error('Ошибка:', error);
                showToast('Ошибка при загрузке статистики заказов', 'danger');
            });
    }
    
    // Создание графика статистики заказов
    function createOrderStatisticsChart(orderData) {
        const ctx = document.getElementById('orderStatisticsChart').getContext('2d');
        
        // Если график уже существует, уничтожаем его
        if (charts.orderStatistics) {
            charts.orderStatistics.destroy();
        }
        
        // Подготавливаем данные
        const labels = orderData.map(item => item.date);
        const data = orderData.map(item => item.count);
        
        // Создаем график
        charts.orderStatistics = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Количество заказов',
                    data: data,
                    backgroundColor: colors.green,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: 'Динамика создания заказов'
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Дата'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Количество заказов'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Создание графика статусов заказов
    function createOrderStatusChart(statusData) {
        const ctx = document.getElementById('orderStatusChart').getContext('2d');
        
        // Если график уже существует, уничтожаем его
        if (charts.orderStatus) {
            charts.orderStatus.destroy();
        }
        
        // Подготавливаем данные
        const labels = [];
        const data = [];
        const backgroundColors = [colors.yellow, colors.blue, colors.green, colors.red];
        
        statusData.forEach((item, index) => {
            let statusLabel = '';
            switch (item.status) {
                case 'new': statusLabel = 'Новые'; break;
                case 'in_progress': statusLabel = 'В работе'; break;
                case 'completed': statusLabel = 'Завершенные'; break;
                case 'cancelled': statusLabel = 'Отмененные'; break;
                default: statusLabel = item.status;
            }
            labels.push(statusLabel);
            data.push(item.count);
        });
        
        // Создаем график
        charts.orderStatus = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Распределение заказов по статусам'
                    }
                }
            }
        });
    }
    
    // Загрузка статистики ставок
    function loadBidStatistics() {
        fetch('/analytics/api/bid-statistics')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка при загрузке данных');
                }
                return response.json();
            })
            .then(data => {
                createBidStatusChart(data.status_statistics);
                updateTopMastersList(data.top_masters);
            })
            .catch(error => {
                console.error('Ошибка:', error);
                showToast('Ошибка при загрузке статистики ставок', 'danger');
            });
    }
    
    // Создание графика статусов ставок
    function createBidStatusChart(statusData) {
        const ctx = document.getElementById('bidStatusChart').getContext('2d');
        
        // Если график уже существует, уничтожаем его
        if (charts.bidStatus) {
            charts.bidStatus.destroy();
        }
        
        // Подготавливаем данные
        const labels = [];
        const data = [];
        const backgroundColors = [colors.yellow, colors.green, colors.red];
        
        statusData.forEach((item, index) => {
            let statusLabel = '';
            switch (item.status) {
                case 'pending': statusLabel = 'Ожидающие'; break;
                case 'accepted': statusLabel = 'Принятые'; break;
                case 'rejected': statusLabel = 'Отклоненные'; break;
                default: statusLabel = item.status;
            }
            labels.push(statusLabel);
            data.push(item.count);
        });
        
        // Создаем график
        charts.bidStatus = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    title: {
                        display: true,
                        text: 'Статусы ставок'
                    }
                }
            }
        });
    }
    
    // Обновление списка топ мастеров
    function updateTopMastersList(topMasters) {
        const listElement = document.getElementById('topMastersList');
        listElement.innerHTML = '';
        
        topMasters.forEach((master, index) => {
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            listItem.innerHTML = `
                ${index + 1}. ${master.name}
                <span class="badge bg-primary rounded-pill">${master.accepted_bids}</span>
            `;
            listElement.appendChild(listItem);
        });
    }
    
    // Загрузка статистики выплат
    function loadPayoutStatistics() {
        fetch('/analytics/api/payout-statistics')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка при загрузке данных');
                }
                return response.json();
            })
            .then(data => {
                createPayoutStatusChart(data.status_statistics);
                createPayoutAmountChart(data.amount_statistics);
            })
            .catch(error => {
                console.error('Ошибка:', error);
                showToast('Ошибка при загрузке статистики выплат', 'danger');
            });
    }
    
    // Создание графика статусов выплат
    function createPayoutStatusChart(statusData) {
        const ctx = document.getElementById('payoutStatusChart').getContext('2d');
        
        // Если график уже существует, уничтожаем его
        if (charts.payoutStatus) {
            charts.payoutStatus.destroy();
        }
        
        // Подготавливаем данные
        const labels = [];
        const data = [];
        const backgroundColors = [colors.yellow, colors.green, colors.red];
        
        statusData.forEach((item, index) => {
            let statusLabel = '';
            switch (item.status) {
                case 'pending': statusLabel = 'Ожидающие'; break;
                case 'approved': statusLabel = 'Одобренные'; break;
                case 'rejected': statusLabel = 'Отклоненные'; break;
                default: statusLabel = item.status;
            }
            labels.push(statusLabel);
            data.push(item.count);
        });
        
        // Создаем график
        charts.payoutStatus = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    title: {
                        display: true,
                        text: 'Статусы выплат'
                    }
                }
            }
        });
    }
    
    // Создание графика сумм выплат
    function createPayoutAmountChart(amountData) {
        const ctx = document.getElementById('payoutAmountChart').getContext('2d');
        
        // Если график уже существует, уничтожаем его
        if (charts.payoutAmount) {
            charts.payoutAmount.destroy();
        }
        
        // Подготавливаем данные
        const labels = amountData.map(item => item.date);
        const data = amountData.map(item => item.amount);
        
        // Создаем график
        charts.payoutAmount = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Сумма выплат',
                    data: data,
                    backgroundColor: colors.purple,
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: 'Динамика выплат'
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Дата'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Сумма'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Загрузка статистики доходов и расходов
    function loadRevenueStatistics(period) {
        fetch(`/analytics/api/revenue-statistics?period=${period}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка при загрузке данных');
                }
                return response.json();
            })
            .then(data => {
                // Обновляем основные показатели
                document.getElementById('totalRevenue').textContent = data.total_revenue.toFixed(2);
                document.getElementById('totalExpenses').textContent = data.total_expenses.toFixed(2);
                document.getElementById('totalProfit').textContent = data.total_profit.toFixed(2);
                
                // Если прибыль положительная - зеленый цвет, отрицательная - красный
                const profitElement = document.getElementById('totalProfit');
                if (data.total_profit >= 0) {
                    profitElement.classList.add('text-success');
                    profitElement.classList.remove('text-danger');
                } else {
                    profitElement.classList.add('text-danger');
                    profitElement.classList.remove('text-success');
                }
                
                createRevenueChart(data.revenue_data);
            })
            .catch(error => {
                console.error('Ошибка:', error);
                showToast('Ошибка при загрузке статистики доходов и расходов', 'danger');
            });
    }
    
    // Создание графика доходов и расходов
    function createRevenueChart(revenueData) {
        const ctx = document.getElementById('revenueChart').getContext('2d');
        
        // Если график уже существует, уничтожаем его
        if (charts.revenue) {
            charts.revenue.destroy();
        }
        
        // Подготавливаем данные
        const labels = revenueData.map(item => item.date);
        const revenueValues = revenueData.map(item => item.revenue);
        const expenseValues = revenueData.map(item => item.expenses);
        const profitValues = revenueData.map(item => item.profit);
        
        // Создаем график
        charts.revenue = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Доходы',
                        data: revenueValues,
                        backgroundColor: colors.green,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Расходы',
                        data: expenseValues,
                        backgroundColor: colors.red,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Прибыль',
                        data: profitValues,
                        backgroundColor: colors.blue,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        type: 'line'
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: 'Динамика доходов и расходов'
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Дата'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Сумма'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Экспорт аналитики в CSV
    function exportAnalytics() {
        fetch('/analytics/api/export')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка при экспорте данных');
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'analytics_export.csv';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                showToast('Экспорт выполнен успешно', 'success');
            })
            .catch(error => {
                console.error('Ошибка:', error);
                showToast('Ошибка при экспорте данных', 'danger');
            });
    }
    
    // Отображение уведомления
    function showToast(message, type) {
        // Создаем элемент toast
        const toastElement = document.createElement('div');
        toastElement.className = `toast align-items-center text-white bg-${type} border-0`;
        toastElement.setAttribute('role', 'alert');
        toastElement.setAttribute('aria-live', 'assertive');
        toastElement.setAttribute('aria-atomic', 'true');
        
        const toastContent = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        toastElement.innerHTML = toastContent;
        
        // Добавляем toast в контейнер
        const toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            const container = document.createElement('div');
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(container);
            container.appendChild(toastElement);
        } else {
            toastContainer.appendChild(toastElement);
        }
        
        // Инициализируем и показываем toast
        const toast = new bootstrap.Toast(toastElement, {
            autohide: true,
            delay: 3000
        });
        toast.show();
    }
</script>
{% endblock %}