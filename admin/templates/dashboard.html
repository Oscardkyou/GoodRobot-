{% extends "base.html" %}

{% block title %}Дашборд - GoodRobot Админ-панель{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Дашборд</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="refresh-data">Обновить данные</button>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card card-dashboard">
            <div class="card-body">
                <h5 class="card-title">Пользователи</h5>
                <h2 class="card-text" id="total-users">-</h2>
                <p class="text-muted">Всего зарегистрировано</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card card-dashboard">
            <div class="card-body">
                <h5 class="card-title">Заказы</h5>
                <h2 class="card-text" id="total-orders">-</h2>
                <p class="text-muted">Всего создано</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card card-dashboard">
            <div class="card-body">
                <h5 class="card-title">Активные заказы</h5>
                <h2 class="card-text" id="active-orders">-</h2>
                <p class="text-muted">В работе</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card card-dashboard">
            <div class="card-body">
                <h5 class="card-title">Средний чек</h5>
                <h2 class="card-text" id="avg-order">-</h2>
                <p class="text-muted">Рублей</p>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Рост пользователей</h5>
                <canvas id="userGrowthChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Статистика заказов</h5>
                <canvas id="orderStatsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Последние заказы</h5>
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Название</th>
                                <th scope="col">Клиент</th>
                                <th scope="col">Мастер</th>
                                <th scope="col">Цена</th>
                                <th scope="col">Статус</th>
                                <th scope="col">Дата</th>
                                <th scope="col">Действия</th>
                            </tr>
                        </thead>
                        <tbody id="recent-orders">
                            <tr>
                                <td colspan="8" class="text-center">Загрузка данных...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Функция для загрузки статистики
    async function loadStatistics() {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch('/analytics/api/statistics', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                document.getElementById('total-users').textContent = data.total_users;
                document.getElementById('total-orders').textContent = data.total_orders;
                document.getElementById('active-orders').textContent = data.active_orders;
                document.getElementById('avg-order').textContent = Math.round(data.average_order_price) + ' ₽';
            } else {
                console.error('Ошибка загрузки статистики');
            }
        } catch (error) {
            console.error('Ошибка:', error);
        }
    }
    
    // Функция для загрузки графика роста пользователей
    async function loadUserGrowthChart() {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch('/analytics/api/user-growth', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                const dates = data.map(item => item.date);
                const counts = data.map(item => item.count);
                
                const ctx = document.getElementById('userGrowthChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Новые пользователи',
                            data: counts,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            borderWidth: 2,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } else {
                console.error('Ошибка загрузки данных о росте пользователей');
            }
        } catch (error) {
            console.error('Ошибка:', error);
        }
    }
    
    // Функция для загрузки статистики заказов
    async function loadOrderStatistics() {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch('/analytics/api/order-statistics', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                const statuses = data.status_statistics.map(item => item.status);
                const counts = data.status_statistics.map(item => item.count);
                
                const ctx = document.getElementById('orderStatsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: statuses,
                        datasets: [{
                            data: counts,
                            backgroundColor: [
                                '#007bff',
                                '#28a745',
                                '#ffc107',
                                '#dc3545',
                                '#6c757d'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            } else {
                console.error('Ошибка загрузки статистики заказов');
            }
        } catch (error) {
            console.error('Ошибка:', error);
        }
    }
    
    // Функция для загрузки последних заказов
    async function loadRecentOrders() {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch('/orders/api?limit=5', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const orders = await response.json();
                const tbody = document.getElementById('recent-orders');
                tbody.innerHTML = '';
                
                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">Нет данных</td></tr>';
                    return;
                }
                
                for (const order of orders) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${order.id}</td>
                        <td>${order.title}</td>
                        <td>${order.client_id}</td>
                        <td>${order.master_id || '-'}</td>
                        <td>${order.price} ₽</td>
                        <td><span class="badge bg-${getStatusBadgeColor(order.status)}">${order.status}</span></td>
                        <td>${new Date(order.created_at).toLocaleDateString()}</td>
                        <td>
                            <a href="/orders/${order.id}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i>
                            </a>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            } else {
                console.error('Ошибка загрузки последних заказов');
            }
        } catch (error) {
            console.error('Ошибка:', error);
        }
    }
    
    // Функция для определения цвета бейджа статуса
    function getStatusBadgeColor(status) {
        switch (status) {
            case 'new': return 'primary';
            case 'in_progress': return 'warning';
            case 'completed': return 'success';
            case 'cancelled': return 'danger';
            default: return 'secondary';
        }
    }
    
    // Загрузка данных при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        loadStatistics();
        loadUserGrowthChart();
        loadOrderStatistics();
        loadRecentOrders();
        
        // Обработчик кнопки обновления данных
        document.getElementById('refresh-data').addEventListener('click', function() {
            loadStatistics();
            loadRecentOrders();
        });
    });
</script>
{% endblock %}