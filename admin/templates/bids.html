{% extends "base.html" %}

{% block title %}Ставки{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Ставки</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshBtn">
                    <i class="bi bi-arrow-clockwise"></i> Обновить
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="exportBtn">
                    <i class="bi bi-download"></i> Экспорт
                </button>
            </div>
        </div>
    </div>

    <!-- Фильтры -->
    <div class="row mb-3">
        <div class="col-md-3">
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" id="searchInput" placeholder="Поиск...">
            </div>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="statusFilter">
                <option value="">Все статусы</option>
                <option value="pending">Ожидает</option>
                <option value="accepted">Принята</option>
                <option value="rejected">Отклонена</option>
            </select>
        </div>
        <div class="col-md-2">
            <input type="date" class="form-control" id="dateFilter" placeholder="Дата">
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control" id="orderIdFilter" placeholder="ID заказа">
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control" id="masterIdFilter" placeholder="ID мастера">
        </div>
        <div class="col-md-1">
            <button class="btn btn-primary w-100" id="applyFilters">Применить</button>
        </div>
    </div>

    <!-- Таблица ставок -->
    <div class="table-responsive">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Заказ ID</th>
                    <th scope="col">Мастер</th>
                    <th scope="col">Сумма</th>
                    <th scope="col">Статус</th>
                    <th scope="col">Дата создания</th>
                    <th scope="col">Действия</th>
                </tr>
            </thead>
            <tbody id="bidsTableBody">
                <!-- Данные будут загружены через JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Пагинация -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center" id="pagination">
            <!-- Пагинация будет добавлена через JavaScript -->
        </ul>
    </nav>

    <!-- Модальное окно для принятия ставки -->
    <div class="modal fade" id="acceptBidModal" tabindex="-1" aria-labelledby="acceptBidModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="acceptBidModalLabel">Принять ставку</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Вы уверены, что хотите принять эту ставку?</p>
                    <p>Это действие назначит мастера на заказ и отклонит все остальные ставки.</p>
                    <div id="acceptBidDetails"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-success" id="confirmAcceptBid">Принять</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для отклонения ставки -->
    <div class="modal fade" id="rejectBidModal" tabindex="-1" aria-labelledby="rejectBidModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rejectBidModalLabel">Отклонить ставку</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Вы уверены, что хотите отклонить эту ставку?</p>
                    <div id="rejectBidDetails"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-danger" id="confirmRejectBid">Отклонить</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Глобальные переменные
    let currentPage = 1;
    let pageSize = 10;
    let totalItems = 0;
    let currentBidId = null;

    // Загрузка данных при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        loadBids();
        
        // Обработчики событий
        document.getElementById('refreshBtn').addEventListener('click', loadBids);
        document.getElementById('applyFilters').addEventListener('click', loadBids);
        document.getElementById('exportBtn').addEventListener('click', exportBids);
        
        // Обработчики для модальных окон
        document.getElementById('confirmAcceptBid').addEventListener('click', acceptBid);
        document.getElementById('confirmRejectBid').addEventListener('click', rejectBid);
    });

    // Функция загрузки ставок
    function loadBids() {
        // Получаем значения фильтров
        const searchQuery = document.getElementById('searchInput').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const dateFilter = document.getElementById('dateFilter').value;
        const orderIdFilter = document.getElementById('orderIdFilter').value;
        const masterIdFilter = document.getElementById('masterIdFilter').value;
        
        // Формируем параметры запроса
        let params = new URLSearchParams({
            skip: (currentPage - 1) * pageSize,
            limit: pageSize
        });
        
        if (statusFilter) params.append('status', statusFilter);
        if (dateFilter) params.append('date', dateFilter);
        if (orderIdFilter) params.append('order_id', orderIdFilter);
        if (masterIdFilter) params.append('master_id', masterIdFilter);
        
        // Выполняем запрос к API
        fetch(`/bids/api?${params.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка при загрузке данных');
                }
                return response.json();
            })
            .then(data => {
                displayBids(data);
                // Предполагаем, что у нас есть заголовок X-Total-Count
                // В реальном приложении нужно получить общее количество элементов
                totalItems = data.length > 0 ? data.length + (currentPage - 1) * pageSize + pageSize : 0;
                updatePagination();
            })
            .catch(error => {
                console.error('Ошибка:', error);
                showToast('Ошибка при загрузке данных', 'danger');
            });
    }

    // Отображение ставок в таблице
    function displayBids(bids) {
        const tableBody = document.getElementById('bidsTableBody');
        tableBody.innerHTML = '';
        
        if (bids.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="7" class="text-center">Нет данных</td>';
            tableBody.appendChild(row);
            return;
        }
        
        bids.forEach(bid => {
            const row = document.createElement('tr');
            
            // Определяем класс для статуса
            let statusClass = '';
            let statusText = '';
            switch (bid.status) {
                case 'pending':
                    statusClass = 'bg-warning text-dark';
                    statusText = 'Ожидает';
                    break;
                case 'accepted':
                    statusClass = 'bg-success text-white';
                    statusText = 'Принята';
                    break;
                case 'rejected':
                    statusClass = 'bg-danger text-white';
                    statusText = 'Отклонена';
                    break;
            }
            
            // Форматируем дату
            const createdDate = new Date(bid.created_at);
            const formattedDate = createdDate.toLocaleDateString('ru-RU') + ' ' + 
                                 createdDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
            
            // Формируем кнопки действий в зависимости от статуса
            let actionsHtml = `<a href="/bids/${bid.id}" class="btn btn-sm btn-info me-1"><i class="bi bi-eye"></i></a>`;
            
            if (bid.status === 'pending') {
                actionsHtml += `
                    <button class="btn btn-sm btn-success me-1" onclick="showAcceptModal(${bid.id}, '${bid.master_name || 'Мастер ' + bid.master_id}', ${bid.amount})">
                        <i class="bi bi-check-lg"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="showRejectModal(${bid.id}, '${bid.master_name || 'Мастер ' + bid.master_id}', ${bid.amount})">
                        <i class="bi bi-x-lg"></i>
                    </button>
                `;
            }
            
            row.innerHTML = `
                <td>${bid.id}</td>
                <td>${bid.order_id}</td>
                <td>${bid.master_name || 'Мастер ' + bid.master_id}</td>
                <td>${bid.amount.toFixed(2)}</td>
                <td><span class="badge ${statusClass}">${statusText}</span></td>
                <td>${formattedDate}</td>
                <td>${actionsHtml}</td>
            `;
            
            tableBody.appendChild(row);
        });
    }

    // Обновление пагинации
    function updatePagination() {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        
        const totalPages = Math.ceil(totalItems / pageSize);
        
        // Кнопка "Предыдущая"
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = '<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>';
        prevLi.addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPage > 1) {
                currentPage--;
                loadBids();
            }
        });
        pagination.appendChild(prevLi);
        
        // Номера страниц
        const maxPages = 5; // Максимальное количество отображаемых страниц
        const startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
        const endPage = Math.min(totalPages, startPage + maxPages - 1);
        
        for (let i = startPage; i <= endPage; i++) {
            const pageLi = document.createElement('li');
            pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
            pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            pageLi.addEventListener('click', function(e) {
                e.preventDefault();
                currentPage = i;
                loadBids();
            });
            pagination.appendChild(pageLi);
        }
        
        // Кнопка "Следующая"
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = '<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>';
        nextLi.addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPage < totalPages) {
                currentPage++;
                loadBids();
            }
        });
        pagination.appendChild(nextLi);
    }

    // Показать модальное окно для принятия ставки
    function showAcceptModal(bidId, masterName, amount) {
        currentBidId = bidId;
        document.getElementById('acceptBidDetails').innerHTML = `
            <p><strong>ID ставки:</strong> ${bidId}</p>
            <p><strong>Мастер:</strong> ${masterName}</p>
            <p><strong>Сумма:</strong> ${amount.toFixed(2)}</p>
        `;
        const modal = new bootstrap.Modal(document.getElementById('acceptBidModal'));
        modal.show();
    }

    // Показать модальное окно для отклонения ставки
    function showRejectModal(bidId, masterName, amount) {
        currentBidId = bidId;
        document.getElementById('rejectBidDetails').innerHTML = `
            <p><strong>ID ставки:</strong> ${bidId}</p>
            <p><strong>Мастер:</strong> ${masterName}</p>
            <p><strong>Сумма:</strong> ${amount.toFixed(2)}</p>
        `;
        const modal = new bootstrap.Modal(document.getElementById('rejectBidModal'));
        modal.show();
    }

    // Принять ставку
    function acceptBid() {
        if (!currentBidId) return;
        
        fetch(`/bids/api/${currentBidId}/accept`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка при принятии ставки');
            }
            return response.json();
        })
        .then(data => {
            bootstrap.Modal.getInstance(document.getElementById('acceptBidModal')).hide();
            showToast('Ставка успешно принята', 'success');
            loadBids();
        })
        .catch(error => {
            console.error('Ошибка:', error);
            showToast('Ошибка при принятии ставки', 'danger');
        });
    }

    // Отклонить ставку
    function rejectBid() {
        if (!currentBidId) return;
        
        fetch(`/bids/api/${currentBidId}/reject`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка при отклонении ставки');
            }
            return response.json();
        })
        .then(data => {
            bootstrap.Modal.getInstance(document.getElementById('rejectBidModal')).hide();
            showToast('Ставка успешно отклонена', 'success');
            loadBids();
        })
        .catch(error => {
            console.error('Ошибка:', error);
            showToast('Ошибка при отклонении ставки', 'danger');
        });
    }

    // Экспорт ставок в CSV
    function exportBids() {
        // Получаем значения фильтров
        const statusFilter = document.getElementById('statusFilter').value;
        const dateFilter = document.getElementById('dateFilter').value;
        const orderIdFilter = document.getElementById('orderIdFilter').value;
        const masterIdFilter = document.getElementById('masterIdFilter').value;
        
        // Формируем параметры запроса для получения всех данных
        let params = new URLSearchParams({
            limit: 1000 // Большое значение для получения всех данных
        });
        
        if (statusFilter) params.append('status', statusFilter);
        if (dateFilter) params.append('date', dateFilter);
        if (orderIdFilter) params.append('order_id', orderIdFilter);
        if (masterIdFilter) params.append('master_id', masterIdFilter);
        
        // Выполняем запрос к API
        fetch(`/bids/api?${params.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка при загрузке данных');
                }
                return response.json();
            })
            .then(data => {
                // Преобразуем данные в формат CSV
                let csv = 'ID,Заказ ID,Мастер ID,Мастер,Сумма,Статус,Дата создания,Комментарий\n';
                
                data.forEach(bid => {
                    const createdDate = new Date(bid.created_at);
                    const formattedDate = createdDate.toLocaleDateString('ru-RU') + ' ' + 
                                         createdDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
                    
                    let status = '';
                    switch (bid.status) {
                        case 'pending': status = 'Ожидает'; break;
                        case 'accepted': status = 'Принята'; break;
                        case 'rejected': status = 'Отклонена'; break;
                    }
                    
                    csv += `${bid.id},${bid.order_id},${bid.master_id},"${bid.master_name || 'Мастер ' + bid.master_id}",${bid.amount.toFixed(2)},"${status}","${formattedDate}","${bid.comment || ''}"\n`;
                });
                
                // Создаем ссылку для скачивания
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `bids_export_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('Экспорт выполнен успешно', 'success');
            })
            .catch(error => {
                console.error('Ошибка:', error);
                showToast('Ошибка при экспорте данных', 'danger');
            });
    }

    // Показать уведомление
    function showToast(message, type) {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        // Удаляем toast после скрытия
        toast.addEventListener('hidden.bs.toast', function() {
            toastContainer.removeChild(toast);
        });
    }
</script>
{% endblock %}