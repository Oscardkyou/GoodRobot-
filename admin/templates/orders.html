{% extends "base.html" %}

{% block title %}Заказы - GoodRobot Админ-панель{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Заказы</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="input-group me-2">
            <input type="text" class="form-control" id="search-order" placeholder="Поиск заказа...">
            <button class="btn btn-outline-secondary" type="button" id="search-button">
                <i class="bi bi-search"></i>
            </button>
        </div>
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="refresh-orders">Обновить</button>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Фильтры</h5>
                <div class="row">
                    <div class="col-md-3">
                        <select class="form-select" id="status-filter">
                            <option value="">Все статусы</option>
                            <option value="new">Новые</option>
                            <option value="in_progress">В работе</option>
                            <option value="completed">Завершенные</option>
                            <option value="cancelled">Отмененные</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="date-filter" placeholder="Дата">
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-primary" id="apply-filters">Применить</button>
                        <button type="button" class="btn btn-outline-secondary" id="reset-filters">Сбросить</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-sm">
        <thead>
            <tr>
                <th scope="col">#</th>
                <th scope="col">Название</th>
                <th scope="col">Клиент</th>
                <th scope="col">Мастер</th>
                <th scope="col">Цена</th>
                <th scope="col">Адрес</th>
                <th scope="col">Геолокация</th>
                <th scope="col">Статус</th>
                <th scope="col">Дата создания</th>
                <th scope="col">Действия</th>
            </tr>
        </thead>
        <tbody id="orders-table">
            <tr>
                <td colspan="9" class="text-center">Загрузка данных...</td>
            </tr>
        </tbody>
    </table>
</div>

<nav aria-label="Навигация по страницам">
    <ul class="pagination justify-content-center" id="pagination">
        <li class="page-item disabled">
            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Предыдущая</a>
        </li>
        <li class="page-item active"><a class="page-link" href="#">1</a></li>
        <li class="page-item">
            <a class="page-link" href="#">Следующая</a>
        </li>
    </ul>
</nav>

<!-- Модальное окно для действий с заказом -->
<div class="modal fade" id="orderActionModal" tabindex="-1" aria-labelledby="orderActionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderActionModalLabel">Подтверждение действия</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="orderActionModalBody">
                Вы уверены, что хотите выполнить это действие?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="confirmOrderAction">Подтвердить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для просмотра геолокации -->
<div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="locationModalLabel">Геолокация заказа</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="map" style="height: 400px;"></div>
                <div class="mt-3">
                    <p><strong>Координаты:</strong> <span id="coordinates"></span></p>
                    <p><small>Для просмотра в Google Maps: <a href="#" id="google-maps-link" target="_blank">Открыть в Google Maps</a></small></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Подключаем Leaflet для отображения карты -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let currentPage = 1;
    const pageSize = 10;
    let totalOrders = 0;
    let currentAction = null;
    let currentOrderId = null;
    
    // Функция для загрузки заказов
    async function loadOrders(page = 1, filters = {}) {
        try {
            const token = localStorage.getItem('token');
            let url = `/orders/api?skip=${(page - 1) * pageSize}&limit=${pageSize}`;
            
            // Добавляем фильтры к URL, если они есть
            if (filters.status) url += `&status=${filters.status}`;
            if (filters.date) url += `&date=${filters.date}`;
            if (filters.search) url += `&search=${encodeURIComponent(filters.search)}`;
            
            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const orders = await response.json();
                const tbody = document.getElementById('orders-table');
                tbody.innerHTML = '';
                
                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center">Нет данных</td></tr>';
                    return;
                }
                
                for (const order of orders) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${order.id}</td>
                        <td>${order.title}</td>
                        <td>${order.client_id}</td>
                        <td>${order.master_id || '-'}</td>
                        <td>${order.price} ₽</td>
                        <td>${order.address}</td>
                        <td>
                            ${order.latitude && order.longitude ? 
                                `<button class="btn btn-sm btn-outline-info view-location" 
                                    data-lat="${order.latitude}" data-lon="${order.longitude}">
                                    <i class="bi bi-geo-alt"></i> Карта
                                </button>` : 
                                'Нет данных'
                            }
                        </td>
                        <td><span class="badge bg-${getStatusBadgeColor(order.status)}">${order.status}</span></td>
                        <td>${new Date(order.created_at).toLocaleDateString()}</td>
                        <td>
                            <div class="btn-group">
                                <a href="/orders/${order.id}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye"></i>
                                </a>
                                ${order.status === 'new' || order.status === 'in_progress' ? 
                                    `<button class="btn btn-sm btn-outline-success complete-order" data-id="${order.id}">
                                        <i class="bi bi-check-lg"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger cancel-order" data-id="${order.id}">
                                        <i class="bi bi-x-lg"></i>
                                    </button>` : 
                                    ''
                                }
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
                
                // Добавляем обработчики событий для кнопок действий
                document.querySelectorAll('.complete-order').forEach(button => {
                    button.addEventListener('click', function() {
                        showOrderActionModal('complete', this.dataset.id);
                    });
                });
                
                document.querySelectorAll('.cancel-order').forEach(button => {
                    button.addEventListener('click', function() {
                        showOrderActionModal('cancel', this.dataset.id);
                    });
                });
                
                // Добавляем обработчики для кнопок просмотра геолокации
                document.querySelectorAll('.view-location').forEach(button => {
                    button.addEventListener('click', function() {
                        showLocationModal(this.dataset.lat, this.dataset.lon);
                    });
                });
                
                // Обновляем пагинацию
                updatePagination(page);
            } else {
                console.error('Ошибка загрузки заказов');
            }
        } catch (error) {
            console.error('Ошибка:', error);
        }
    }
    
    // Функция для определения цвета бейджа статуса
    function getStatusBadgeColor(status) {
        switch (status) {
            case 'new': return 'primary';
            case 'in_progress': return 'warning';
            case 'completed': return 'success';
            case 'cancelled': return 'danger';
            default: return 'secondary';
        }
    }
    
    // Функция для обновления пагинации
    function updatePagination(currentPage) {
        const totalPages = Math.ceil(totalOrders / pageSize);
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        
        // Кнопка "Предыдущая"
        const prevItem = document.createElement('li');
        prevItem.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        const prevLink = document.createElement('a');
        prevLink.className = 'page-link';
        prevLink.href = '#';
        prevLink.textContent = 'Предыдущая';
        if (currentPage > 1) {
            prevLink.addEventListener('click', function(e) {
                e.preventDefault();
                loadOrders(currentPage - 1, getFilters());
            });
        }
        prevItem.appendChild(prevLink);
        pagination.appendChild(prevItem);
        
        // Номера страниц
        for (let i = 1; i <= totalPages; i++) {
            const pageItem = document.createElement('li');
            pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
            const pageLink = document.createElement('a');
            pageLink.className = 'page-link';
            pageLink.href = '#';
            pageLink.textContent = i;
            pageLink.addEventListener('click', function(e) {
                e.preventDefault();
                loadOrders(i, getFilters());
            });
            pageItem.appendChild(pageLink);
            pagination.appendChild(pageItem);
        }
        
        // Кнопка "Следующая"
        const nextItem = document.createElement('li');
        nextItem.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        const nextLink = document.createElement('a');
        nextLink.className = 'page-link';
        nextLink.href = '#';
        nextLink.textContent = 'Следующая';
        if (currentPage < totalPages) {
            nextLink.addEventListener('click', function(e) {
                e.preventDefault();
                loadOrders(currentPage + 1, getFilters());
            });
        }
        nextItem.appendChild(nextLink);
        pagination.appendChild(nextItem);
    }
    
    // Функция для получения текущих фильтров
    function getFilters() {
        return {
            status: document.getElementById('status-filter').value,
            date: document.getElementById('date-filter').value,
            search: document.getElementById('search-order').value
        };
    }
    
    // Функция для отображения модального окна подтверждения действия
    function showOrderActionModal(action, orderId) {
        const modal = new bootstrap.Modal(document.getElementById('orderActionModal'));
        const modalBody = document.getElementById('orderActionModalBody');
        
        currentAction = action;
        currentOrderId = orderId;
        
        if (action === 'complete') {
            modalBody.textContent = `Вы уверены, что хотите завершить заказ #${orderId}?`;
        } else {
            modalBody.textContent = `Вы уверены, что хотите отменить заказ #${orderId}?`;
        }
        
        modal.show();
    }
    
    // Функция для выполнения действия с заказом
    async function performOrderAction() {
        try {
            const token = localStorage.getItem('token');
            const url = `/orders/api/${currentOrderId}/${currentAction}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                // Закрываем модальное окно
                const modal = bootstrap.Modal.getInstance(document.getElementById('orderActionModal'));
                modal.hide();
                
                // Перезагружаем список заказов
                loadOrders(currentPage, getFilters());
            } else {
                console.error('Ошибка выполнения действия');
            }
        } catch (error) {
            console.error('Ошибка:', error);
        }
    }
    
    // Загрузка данных при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        loadOrders();
        
        // Обработчик кнопки обновления
        document.getElementById('refresh-orders').addEventListener('click', function() {
            loadOrders(currentPage, getFilters());
        });
        
        // Обработчик кнопки применения фильтров
        document.getElementById('apply-filters').addEventListener('click', function() {
            loadOrders(1, getFilters());
        });
        
        // Обработчик кнопки сброса фильтров
        document.getElementById('reset-filters').addEventListener('click', function() {
            document.getElementById('status-filter').value = '';
            document.getElementById('date-filter').value = '';
            document.getElementById('search-order').value = '';
            loadOrders(1, {});
        });
        
        // Обработчик кнопки поиска
        document.getElementById('search-button').addEventListener('click', function() {
            loadOrders(1, getFilters());
        });
        
        // Обработчик ввода в поле поиска
        document.getElementById('search-order').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadOrders(1, getFilters());
            }
        });
        
        // Обработчик кнопки подтверждения действия
        document.getElementById('confirmOrderAction').addEventListener('click', performOrderAction);
        
        // Инициализация карты при открытии модального окна
        document.getElementById('locationModal').addEventListener('shown.bs.modal', function () {
            // Если карта уже инициализирована, обновляем её размер
            if (window.map) {
                window.map.invalidateSize();
            }
        });
    });
    
    // Функция для отображения модального окна с картой
    function showLocationModal(lat, lon) {
        const modal = new bootstrap.Modal(document.getElementById('locationModal'));
        const coordinates = document.getElementById('coordinates');
        const googleMapsLink = document.getElementById('google-maps-link');
        
        // Устанавливаем координаты
        coordinates.textContent = `${lat}, ${lon}`;
        
        // Устанавливаем ссылку на Google Maps
        googleMapsLink.href = `https://www.google.com/maps?q=${lat},${lon}`;
        
        // Показываем модальное окно
        modal.show();
        
        // Инициализируем карту после того, как модальное окно будет показано
        setTimeout(() => {
            // Если карта уже инициализирована, удаляем её
            if (window.map) {
                window.map.remove();
            }
            
            // Создаем новую карту
            window.map = L.map('map').setView([lat, lon], 15);
            
            // Добавляем слой OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(window.map);
            
            // Добавляем маркер
            L.marker([lat, lon]).addTo(window.map)
                .bindPopup('Местоположение заказа')
                .openPopup();
        }, 300);
    }
</script>
{% endblock %}