{% extends "base.html" %}

{% block title %}Выплаты{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Выплаты</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshBtn">
                    <i class="bi bi-arrow-clockwise"></i> Обновить
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="exportBtn">
                    <i class="bi bi-download"></i> Экспорт
                </button>
            </div>
            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createPayoutModal">
                <i class="bi bi-plus-lg"></i> Создать выплату
            </button>
        </div>
    </div>

    <!-- Фильтры -->
    <div class="row mb-3">
        <div class="col-md-3">
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" id="searchInput" placeholder="Поиск...">
            </div>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="statusFilter">
                <option value="">Все статусы</option>
                <option value="pending">Ожидает</option>
                <option value="approved">Одобрена</option>
                <option value="rejected">Отклонена</option>
            </select>
        </div>
        <div class="col-md-2">
            <input type="date" class="form-control" id="dateFromFilter" placeholder="С даты">
        </div>
        <div class="col-md-2">
            <input type="date" class="form-control" id="dateToFilter" placeholder="По дату">
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control" id="userIdFilter" placeholder="ID пользователя">
        </div>
        <div class="col-md-1">
            <button class="btn btn-primary w-100" id="applyFilters">Применить</button>
        </div>
    </div>

    <!-- Таблица выплат -->
    <div class="table-responsive">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Пользователь</th>
                    <th scope="col">Сумма</th>
                    <th scope="col">Метод оплаты</th>
                    <th scope="col">Статус</th>
                    <th scope="col">Дата создания</th>
                    <th scope="col">Дата обработки</th>
                    <th scope="col">Действия</th>
                </tr>
            </thead>
            <tbody id="payoutsTableBody">
                <!-- Данные будут загружены через JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Пагинация -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center" id="pagination">
            <!-- Пагинация будет добавлена через JavaScript -->
        </ul>
    </nav>

    <!-- Модальное окно для создания выплаты -->
    <div class="modal fade" id="createPayoutModal" tabindex="-1" aria-labelledby="createPayoutModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createPayoutModalLabel">Создать выплату</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createPayoutForm">
                        <div class="mb-3">
                            <label for="userId" class="form-label">ID пользователя</label>
                            <input type="number" class="form-control" id="userId" required>
                        </div>
                        <div class="mb-3">
                            <label for="amount" class="form-label">Сумма</label>
                            <input type="number" class="form-control" id="amount" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="paymentMethod" class="form-label">Метод оплаты</label>
                            <select class="form-select" id="paymentMethod" required>
                                <option value="bank_card">Банковская карта</option>
                                <option value="bank_account">Банковский счет</option>
                                <option value="paypal">PayPal</option>
                                <option value="crypto">Криптовалюта</option>
                                <option value="cash">Наличные</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="paymentDetails" class="form-label">Детали платежа</label>
                            <textarea class="form-control" id="paymentDetails" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Описание</label>
                            <textarea class="form-control" id="description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="createPayoutBtn">Создать</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для подтверждения выплаты -->
    <div class="modal fade" id="approvePayoutModal" tabindex="-1" aria-labelledby="approvePayoutModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="approvePayoutModalLabel">Подтвердить выплату</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Вы уверены, что хотите подтвердить эту выплату?</p>
                    <div id="approvePayoutDetails"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-success" id="confirmApprovePayout">Подтвердить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для отклонения выплаты -->
    <div class="modal fade" id="rejectPayoutModal" tabindex="-1" aria-labelledby="rejectPayoutModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rejectPayoutModalLabel">Отклонить выплату</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Вы уверены, что хотите отклонить эту выплату?</p>
                    <div id="rejectPayoutDetails"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-danger" id="confirmRejectPayout">Отклонить</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Глобальные переменные
    let currentPage = 1;
    let pageSize = 10;
    let totalItems = 0;
    let currentPayoutId = null;

    // Загрузка данных при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        loadPayouts();
        
        // Обработчики событий
        document.getElementById('refreshBtn').addEventListener('click', loadPayouts);
        document.getElementById('applyFilters').addEventListener('click', loadPayouts);
        document.getElementById('exportBtn').addEventListener('click', exportPayouts);
        document.getElementById('createPayoutBtn').addEventListener('click', createPayout);
        
        // Обработчики для модальных окон
        document.getElementById('confirmApprovePayout').addEventListener('click', approvePayout);
        document.getElementById('confirmRejectPayout').addEventListener('click', rejectPayout);
    });

    // Функция загрузки выплат
    function loadPayouts() {
        // Получаем значения фильтров
        const searchQuery = document.getElementById('searchInput').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const dateFromFilter = document.getElementById('dateFromFilter').value;
        const dateToFilter = document.getElementById('dateToFilter').value;
        const userIdFilter = document.getElementById('userIdFilter').value;
        
        // Формируем параметры запроса
        let params = new URLSearchParams({
            skip: (currentPage - 1) * pageSize,
            limit: pageSize
        });
        
        if (statusFilter) params.append('status', statusFilter);
        if (dateFromFilter) params.append('date_from', dateFromFilter);
        if (dateToFilter) params.append('date_to', dateToFilter);
        if (userIdFilter) params.append('user_id', userIdFilter);
        
        // Выполняем запрос к API
        fetch(`/payouts/api?${params.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка при загрузке данных');
                }
                return response.json();
            })
            .then(data => {
                displayPayouts(data);
                // Предполагаем, что у нас есть заголовок X-Total-Count
                // В реальном приложении нужно получить общее количество элементов
                totalItems = data.length > 0 ? data.length + (currentPage - 1) * pageSize + pageSize : 0;
                updatePagination();
            })
            .catch(error => {
                console.error('Ошибка:', error);
                showToast('Ошибка при загрузке данных', 'danger');
            });
    }

    // Отображение выплат в таблице
    function displayPayouts(payouts) {
        const tableBody = document.getElementById('payoutsTableBody');
        tableBody.innerHTML = '';
        
        if (payouts.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="8" class="text-center">Нет данных</td>';
            tableBody.appendChild(row);
            return;
        }
        
        payouts.forEach(payout => {
            const row = document.createElement('tr');
            
            // Определяем класс для статуса
            let statusClass = '';
            let statusText = '';
            switch (payout.status) {
                case 'pending':
                    statusClass = 'bg-warning text-dark';
                    statusText = 'Ожидает';
                    break;
                case 'approved':
                    statusClass = 'bg-success text-white';
                    statusText = 'Одобрена';
                    break;
                case 'rejected':
                    statusClass = 'bg-danger text-white';
                    statusText = 'Отклонена';
                    break;
            }
            
            // Форматируем даты
            const createdDate = new Date(payout.created_at);
            const formattedCreatedDate = createdDate.toLocaleDateString('ru-RU') + ' ' + 
                                        createdDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
            
            let formattedProcessedDate = '-';
            if (payout.processed_at) {
                const processedDate = new Date(payout.processed_at);
                formattedProcessedDate = processedDate.toLocaleDateString('ru-RU') + ' ' + 
                                        processedDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
            }
            
            // Форматируем метод оплаты
            let paymentMethodText = '';
            switch (payout.payment_method) {
                case 'bank_card':
                    paymentMethodText = 'Банковская карта';
                    break;
                case 'bank_account':
                    paymentMethodText = 'Банковский счет';
                    break;
                case 'paypal':
                    paymentMethodText = 'PayPal';
                    break;
                case 'crypto':
                    paymentMethodText = 'Криптовалюта';
                    break;
                case 'cash':
                    paymentMethodText = 'Наличные';
                    break;
                default:
                    paymentMethodText = payout.payment_method;
            }
            
            // Формируем кнопки действий в зависимости от статуса
            let actionsHtml = `<a href="/payouts/${payout.id}" class="btn btn-sm btn-info me-1"><i class="bi bi-eye"></i></a>`;
            
            if (payout.status === 'pending') {
                actionsHtml += `
                    <button class="btn btn-sm btn-success me-1" onclick="showApproveModal(${payout.id}, '${payout.user_name || 'Пользователь ' + payout.user_id}', ${payout.amount})">
                        <i class="bi bi-check-lg"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="showRejectModal(${payout.id}, '${payout.user_name || 'Пользователь ' + payout.user_id}', ${payout.amount})">
                        <i class="bi bi-x-lg"></i>
                    </button>
                `;
            }
            
            row.innerHTML = `
                <td>${payout.id}</td>
                <td>${payout.user_name || 'Пользователь ' + payout.user_id}</td>
                <td>${payout.amount.toFixed(2)}</td>
                <td>${paymentMethodText}</td>
                <td><span class="badge ${statusClass}">${statusText}</span></td>
                <td>${formattedCreatedDate}</td>
                <td>${formattedProcessedDate}</td>
                <td>${actionsHtml}</td>
            `;
            
            tableBody.appendChild(row);
        });
    }

    // Обновление пагинации
    function updatePagination() {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        
        const totalPages = Math.ceil(totalItems / pageSize);
        
        // Кнопка "Предыдущая"
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = '<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>';
        prevLi.addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPage > 1) {
                currentPage--;
                loadPayouts();
            }
        });
        pagination.appendChild(prevLi);
        
        // Номера страниц
        const maxPages = 5; // Максимальное количество отображаемых страниц
        const startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
        const endPage = Math.min(totalPages, startPage + maxPages - 1);
        
        for (let i = startPage; i <= endPage; i++) {
            const pageLi = document.createElement('li');
            pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
            pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            pageLi.addEventListener('click', function(e) {
                e.preventDefault();
                currentPage = i;
                loadPayouts();
            });
            pagination.appendChild(pageLi);
        }
        
        // Кнопка "Следующая"
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = '<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>';
        nextLi.addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPage < totalPages) {
                currentPage++;
                loadPayouts();
            }
        });
        pagination.appendChild(nextLi);
    }

    // Показать модальное окно для подтверждения выплаты
    function showApproveModal(payoutId, userName, amount) {
        currentPayoutId = payoutId;
        document.getElementById('approvePayoutDetails').innerHTML = `
            <p><strong>ID выплаты:</strong> ${payoutId}</p>
            <p><strong>Пользователь:</strong> ${userName}</p>
            <p><strong>Сумма:</strong> ${amount.toFixed(2)}</p>
        `;
        const modal = new bootstrap.Modal(document.getElementById('approvePayoutModal'));
        modal.show();
    }

    // Показать модальное окно для отклонения выплаты
    function showRejectModal(payoutId, userName, amount) {
        currentPayoutId = payoutId;
        document.getElementById('rejectPayoutDetails').innerHTML = `
            <p><strong>ID выплаты:</strong> ${payoutId}</p>
            <p><strong>Пользователь:</strong> ${userName}</p>
            <p><strong>Сумма:</strong> ${amount.toFixed(2)}</p>
        `;
        const modal = new bootstrap.Modal(document.getElementById('rejectPayoutModal'));
        modal.show();
    }

    // Подтвердить выплату
    function approvePayout() {
        if (!currentPayoutId) return;
        
        fetch(`/payouts/api/${currentPayoutId}/approve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка при подтверждении выплаты');
            }
            return response.json();
        })
        .then(data => {
            bootstrap.Modal.getInstance(document.getElementById('approvePayoutModal')).hide();
            showToast('Выплата успешно подтверждена', 'success');
            loadPayouts();
        })
        .catch(error => {
            console.error('Ошибка:', error);
            showToast('Ошибка при подтверждении выплаты', 'danger');
        });
    }

    // Отклонить выплату
    function rejectPayout() {
        if (!currentPayoutId) return;
        
        fetch(`/payouts/api/${currentPayoutId}/reject`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка при отклонении выплаты');
            }
            return response.json();
        })
        .then(data => {
            bootstrap.Modal.getInstance(document.getElementById('rejectPayoutModal')).hide();
            showToast('Выплата успешно отклонена', 'success');
            loadPayouts();
        })
        .catch(error => {
            console.error('Ошибка:', error);
            showToast('Ошибка при отклонении выплаты', 'danger');
        });
    }

    // Создать выплату
    function createPayout() {
        const userId = document.getElementById('userId').value;
        const amount = document.getElementById('amount').value;
        const paymentMethod = document.getElementById('paymentMethod').value;
        const paymentDetails = document.getElementById('paymentDetails').value;
        const description = document.getElementById('description').value;
        
        // Проверяем обязательные поля
        if (!userId || !amount || !paymentMethod) {
            showToast('Заполните все обязательные поля', 'warning');
            return;
        }
        
        // Формируем данные для отправки
        const payoutData = {
            user_id: parseInt(userId),
            amount: parseFloat(amount),
            payment_method: paymentMethod,
            payment_details: paymentDetails,
            description: description
        };
        
        // Отправляем запрос к API
        fetch('/payouts/api', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify(payoutData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка при создании выплаты');
            }
            return response.json();
        })
        .then(data => {
            bootstrap.Modal.getInstance(document.getElementById('createPayoutModal')).hide();
            showToast('Выплата успешно создана', 'success');
            
            // Очищаем форму
            document.getElementById('createPayoutForm').reset();
            
            // Обновляем список выплат
            loadPayouts();
        })
        .catch(error => {
            console.error('Ошибка:', error);
            showToast('Ошибка при создании выплаты', 'danger');
        });
    }

    // Экспорт выплат в CSV
    function exportPayouts() {
        // Получаем значения фильтров
        const statusFilter = document.getElementById('statusFilter').value;
        const dateFromFilter = document.getElementById('dateFromFilter').value;
        const dateToFilter = document.getElementById('dateToFilter').value;
        const userIdFilter = document.getElementById('userIdFilter').value;
        
        // Формируем параметры запроса для получения всех данных
        let params = new URLSearchParams({
            limit: 1000 // Большое значение для получения всех данных
        });
        
        if (statusFilter) params.append('status', statusFilter);
        if (dateFromFilter) params.append('date_from', dateFromFilter);
        if (dateToFilter) params.append('date_to', dateToFilter);
        if (userIdFilter) params.append('user_id', userIdFilter);
        
        // Выполняем запрос к API
        fetch(`/payouts/api?${params.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка при загрузке данных');
                }
                return response.json();
            })
            .then(data => {
                // Преобразуем данные в формат CSV
                let csv = 'ID,Пользователь ID,Пользователь,Сумма,Метод оплаты,Статус,Дата создания,Дата обработки,Детали платежа,Описание\n';
                
                data.forEach(payout => {
                    const createdDate = new Date(payout.created_at);
                    const formattedCreatedDate = createdDate.toLocaleDateString('ru-RU') + ' ' + 
                                                createdDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
                    
                    let formattedProcessedDate = '';
                    if (payout.processed_at) {
                        const processedDate = new Date(payout.processed_at);
                        formattedProcessedDate = processedDate.toLocaleDateString('ru-RU') + ' ' + 
                                                processedDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
                    }
                    
                    let status = '';
                    switch (payout.status) {
                        case 'pending': status = 'Ожидает'; break;
                        case 'approved': status = 'Одобрена'; break;
                        case 'rejected': status = 'Отклонена'; break;
                    }
                    
                    let paymentMethod = '';
                    switch (payout.payment_method) {
                        case 'bank_card': paymentMethod = 'Банковская карта'; break;
                        case 'bank_account': paymentMethod = 'Банковский счет'; break;
                        case 'paypal': paymentMethod = 'PayPal'; break;
                        case 'crypto': paymentMethod = 'Криптовалюта'; break;
                        case 'cash': paymentMethod = 'Наличные'; break;
                        default: paymentMethod = payout.payment_method;
                    }
                    
                    csv += `${payout.id},${payout.user_id},"${payout.user_name || 'Пользователь ' + payout.user_id}",${payout.amount.toFixed(2)},"${paymentMethod}","${status}","${formattedCreatedDate}","${formattedProcessedDate}","${payout.payment_details || ''}","${payout.description || ''}"\n`;
                });
                
                // Создаем ссылку для скачивания
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `payouts_export_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('Экспорт выполнен успешно', 'success');
            })
            .catch(error => {
                console.error('Ошибка:', error);
                showToast('Ошибка при экспорте данных', 'danger');
            });
    }

    // Показать уведомление
    function showToast(message, type) {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        // Удаляем toast после скрытия
        toast.addEventListener('hidden.bs.toast', function() {
            toastContainer.removeChild(toast);
        });
    }
</script>
{% endblock %}