{% extends "base.html" %}

{% block title %}Список специалистов{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Список специалистов</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="/">Главная</a></li>
        <li class="breadcrumb-item active">Специалисты</li>
    </ol>
    
    <div class="card mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-user-hard-hat me-1"></i>
                    Специалисты
                </div>
                <div class="d-flex">
                    <input type="text" id="searchInput" class="form-control me-2" placeholder="Поиск...">
                    <select id="specialtyFilter" class="form-select me-2">
                        <option value="">Все специальности</option>
                        <!-- Специальности будут загружены через JavaScript -->
                    </select>
                    <select id="statusFilter" class="form-select me-2">
                        <option value="">Все статусы</option>
                        <option value="true">Активные</option>
                        <option value="false">Неактивные</option>
                    </select>
                    <button id="refreshBtn" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="specialistsTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Имя</th>
                            <th>Телефон</th>
                            <th>Специальности</th>
                            <th>Рейтинг</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="specialistsTableBody">
                        <!-- Данные будут загружены через JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div>
                    <span id="totalCount">0</span> специалистов
                </div>
                <div>
                    <button id="prevPageBtn" class="btn btn-sm btn-outline-secondary me-2">
                        <i class="fas fa-chevron-left"></i> Назад
                    </button>
                    <span id="currentPage">1</span> из <span id="totalPages">1</span>
                    <button id="nextPageBtn" class="btn btn-sm btn-outline-secondary ms-2">
                        Вперед <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для просмотра деталей специалиста -->
<div class="modal fade" id="specialistDetailsModal" tabindex="-1" aria-labelledby="specialistDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="specialistDetailsModalLabel">Детали специалиста</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>ID:</strong> <span id="modalSpecialistId"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Telegram ID:</strong> <span id="modalTelegramId"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Имя:</strong> <span id="modalFullName"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Username:</strong> <span id="modalUsername"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Телефон:</strong> <span id="modalPhone"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Email:</strong> <span id="modalEmail"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Рейтинг:</strong> <span id="modalRating"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Статус:</strong> <span id="modalStatus"></span>
                    </div>
                </div>
                <div class="mb-3">
                    <strong>Специальности:</strong>
                    <div id="modalSpecialties" class="mt-2"></div>
                </div>
                <div class="card mb-3">
                    <div class="card-header">Статистика заказов</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 text-center">
                                <h4 id="modalTotalOrders">0</h4>
                                <p class="text-muted">Всего заказов</p>
                            </div>
                            <div class="col-md-4 text-center">
                                <h4 id="modalCompletedOrders">0</h4>
                                <p class="text-muted">Выполнено</p>
                            </div>
                            <div class="col-md-4 text-center">
                                <h4 id="modalCompletionRate">0%</h4>
                                <p class="text-muted">Процент выполнения</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="toggleActiveBtn" class="btn btn-warning">
                    <i class="fas fa-toggle-on"></i> <span id="toggleActiveText">Деактивировать</span>
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Глобальные переменные для пагинации и фильтрации
    let currentPage = 1;
    let pageSize = 20;
    let totalItems = 0;
    let currentFilter = {
        search: '',
        specialty: '',
        status: ''
    };
    let currentSpecialist = null;

    // Загрузка данных с сервера
    async function loadSpecialists() {
        try {
            const skip = (currentPage - 1) * pageSize;
            let url = `/specialists/api?skip=${skip}&limit=${pageSize}`;
            
            if (currentFilter.specialty) {
                url += `&specialty_id=${encodeURIComponent(currentFilter.specialty)}`;
            }
            
            if (currentFilter.status !== '') {
                url += `&is_active=${currentFilter.status}`;
            }
            
            if (currentFilter.search) {
                url += `&search=${encodeURIComponent(currentFilter.search)}`;
            }
            
            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Ошибка загрузки данных');
            }
            
            const data = await response.json();
            renderSpecialists(data);
            
            // Обновляем информацию о пагинации
            totalItems = data.length >= pageSize ? (currentPage * pageSize) + 1 : (currentPage - 1) * pageSize + data.length;
            document.getElementById('totalCount').textContent = totalItems;
            
            const totalPages = Math.ceil(totalItems / pageSize) || 1;
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('currentPage').textContent = currentPage;
            
            // Управление кнопками пагинации
            document.getElementById('prevPageBtn').disabled = currentPage <= 1;
            document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
        } catch (error) {
            console.error('Ошибка при загрузке специалистов:', error);
            alert('Не удалось загрузить данные. Пожалуйста, проверьте соединение и авторизацию.');
        }
    }

    // Загрузка списка специальностей для фильтра
    async function loadSpecialties() {
        try {
            const response = await fetch('/specialists/api/specialties', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Ошибка загрузки специальностей');
            }
            
            const specialties = await response.json();
            const selectElement = document.getElementById('specialtyFilter');
            
            // Очищаем текущие опции, оставляя только первую (Все специальности)
            while (selectElement.options.length > 1) {
                selectElement.remove(1);
            }
            
            // Добавляем новые опции
            specialties.forEach(specialty => {
                const option = document.createElement('option');
                option.value = specialty.id;
                option.textContent = specialty.name;
                selectElement.appendChild(option);
            });
        } catch (error) {
            console.error('Ошибка при загрузке специальностей:', error);
        }
    }

    // Отображение данных в таблице
    function renderSpecialists(specialists) {
        const tableBody = document.getElementById('specialistsTableBody');
        tableBody.innerHTML = '';
        
        if (specialists.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="7" class="text-center">Нет данных</td>';
            tableBody.appendChild(row);
            return;
        }
        
        specialists.forEach(specialist => {
            const row = document.createElement('tr');
            
            // Формируем список специальностей
            const specialtiesList = specialist.specialties && specialist.specialties.length > 0
                ? specialist.specialties.map(s => s.name).join(', ')
                : 'Не указаны';
            
            // Статус активности
            const statusBadge = specialist.is_active
                ? '<span class="badge bg-success">Активен</span>'
                : '<span class="badge bg-danger">Неактивен</span>';
            
            // Рейтинг со звездами
            const rating = specialist.rating_avg || 0;
            const ratingStars = `<div class="text-warning">
                ${rating.toFixed(1)} 
                ${Array(Math.round(rating)).fill('<i class="fas fa-star"></i>').join('')}
                ${Array(5 - Math.round(rating)).fill('<i class="far fa-star"></i>').join('')}
            </div>`;
            
            row.innerHTML = `
                <td>${specialist.id}</td>
                <td>${specialist.full_name || 'Без имени'}</td>
                <td>${specialist.phone || 'Не указан'}</td>
                <td>${specialtiesList}</td>
                <td>${ratingStars}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-sm btn-info view-details" data-id="${specialist.id}">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-warning toggle-active" data-id="${specialist.id}" data-active="${specialist.is_active}">
                        <i class="fas fa-toggle-${specialist.is_active ? 'on' : 'off'}"></i>
                    </button>
                </td>
            `;
            
            tableBody.appendChild(row);
            
            // Добавляем обработчики для кнопок
            const viewButton = row.querySelector('.view-details');
            viewButton.addEventListener('click', () => loadSpecialistDetails(specialist.id));
            
            const toggleButton = row.querySelector('.toggle-active');
            toggleButton.addEventListener('click', () => toggleSpecialistActive(specialist.id));
        });
    }

    // Загрузка деталей специалиста
    async function loadSpecialistDetails(specialistId) {
        try {
            const response = await fetch(`/specialists/api/${specialistId}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Ошибка загрузки данных специалиста');
            }
            
            const specialist = await response.json();
            currentSpecialist = specialist;
            showSpecialistDetails(specialist);
        } catch (error) {
            console.error('Ошибка при загрузке деталей специалиста:', error);
            alert('Не удалось загрузить данные специалиста.');
        }
    }

    // Показ модального окна с деталями специалиста
    function showSpecialistDetails(specialist) {
        document.getElementById('modalSpecialistId').textContent = specialist.id;
        document.getElementById('modalTelegramId').textContent = specialist.telegram_id || 'Не указан';
        document.getElementById('modalFullName').textContent = specialist.full_name || 'Без имени';
        document.getElementById('modalUsername').textContent = specialist.username || 'Не указан';
        document.getElementById('modalPhone').textContent = specialist.phone || 'Не указан';
        document.getElementById('modalEmail').textContent = specialist.email || 'Не указан';
        document.getElementById('modalRating').textContent = `${specialist.rating.toFixed(1)} / 5.0`;
        
        // Статус
        const statusElement = document.getElementById('modalStatus');
        statusElement.textContent = specialist.is_active ? 'Активен' : 'Неактивен';
        statusElement.className = specialist.is_active ? 'text-success' : 'text-danger';
        
        // Специальности
        const specialtiesElement = document.getElementById('modalSpecialties');
        specialtiesElement.innerHTML = '';
        
        if (specialist.specialties && specialist.specialties.length > 0) {
            specialist.specialties.forEach(specialty => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-primary me-1 mb-1';
                badge.textContent = specialty.name;
                specialtiesElement.appendChild(badge);
            });
        } else {
            specialtiesElement.textContent = 'Не указаны';
        }
        
        // Статистика заказов
        document.getElementById('modalTotalOrders').textContent = specialist.orders_stats.total;
        document.getElementById('modalCompletedOrders').textContent = specialist.orders_stats.completed;
        document.getElementById('modalCompletionRate').textContent = `${specialist.orders_stats.completion_rate}%`;
        
        // Кнопка переключения активности
        const toggleBtn = document.getElementById('toggleActiveBtn');
        const toggleText = document.getElementById('toggleActiveText');
        
        if (specialist.is_active) {
            toggleBtn.className = 'btn btn-warning';
            toggleText.textContent = 'Деактивировать';
        } else {
            toggleBtn.className = 'btn btn-success';
            toggleText.textContent = 'Активировать';
        }
        
        // Показываем модальное окно
        const modal = new bootstrap.Modal(document.getElementById('specialistDetailsModal'));
        modal.show();
    }

    // Переключение активности специалиста
    async function toggleSpecialistActive(specialistId) {
        try {
            const response = await fetch(`/specialists/api/${specialistId}/toggle-active`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Ошибка при изменении статуса');
            }
            
            // Перезагружаем данные
            loadSpecialists();
            
            // Если открыто модальное окно с этим специалистом, обновляем его
            if (currentSpecialist && currentSpecialist.id === specialistId) {
                loadSpecialistDetails(specialistId);
            }
        } catch (error) {
            console.error('Ошибка при изменении статуса специалиста:', error);
            alert('Не удалось изменить статус специалиста.');
        }
    }

    // Обработчики событий
    document.addEventListener('DOMContentLoaded', function() {
        // Загрузка данных при загрузке страницы
        loadSpecialists();
        loadSpecialties();
        
        // Обработчик для кнопки обновления
        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadSpecialists();
            loadSpecialties();
        });
        
        // Обработчики пагинации
        document.getElementById('prevPageBtn').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                loadSpecialists();
            }
        });
        
        document.getElementById('nextPageBtn').addEventListener('click', () => {
            currentPage++;
            loadSpecialists();
        });
        
        // Фильтр по специальности
        document.getElementById('specialtyFilter').addEventListener('change', function() {
            currentFilter.specialty = this.value;
            currentPage = 1;
            loadSpecialists();
        });
        
        // Фильтр по статусу
        document.getElementById('statusFilter').addEventListener('change', function() {
            currentFilter.status = this.value;
            currentPage = 1;
            loadSpecialists();
        });
        
        // Поиск
        const searchInput = document.getElementById('searchInput');
        let searchTimeout;
        
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentFilter.search = this.value.trim();
                currentPage = 1;
                loadSpecialists();
            }, 500);
        });
        
        // Кнопка переключения активности в модальном окне
        document.getElementById('toggleActiveBtn').addEventListener('click', function() {
            if (currentSpecialist) {
                toggleSpecialistActive(currentSpecialist.id);
            }
        });
    });
</script>
{% endblock %}