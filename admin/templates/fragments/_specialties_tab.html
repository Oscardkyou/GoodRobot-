{# Partial for specialties tab inside management.html #}
<div id="specialties-tab-content">
    <!-- BEGIN specialties content copied from specialties.html (without extends) -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h2>Управление специальностями</h2>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="input-group me-2">
                <input type="text" class="form-control" id="search-specialty" placeholder="Поиск специальности...">
                <button class="btn btn-outline-secondary" type="button" id="search-button">
                    <i class="bi bi-search"></i>
                </button>
            </div>
            <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" id="refresh-specialties">Обновить</button>
                <button type="button" class="btn btn-sm btn-success" id="add-specialty-btn">Добавить специальность</button>
            </div>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Фильтры</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <select class="form-select" id="status-filter">
                                <option value="">Все статусы</option>
                                <option value="active">Активные</option>
                                <option value="inactive">Неактивные</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Название</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="specialties-table">
                {% for specialty in specialties %}
                <tr>
                    <td>{{ specialty.id }}</td>
                    <td>{{ specialty.name }}</td>
                    <td>
                        {% if specialty.is_active %}
                        <span class="badge bg-success">Активна</span>
                        {% else %}
                        <span class="badge bg-danger">Неактивна</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group">
                            <a href="/specialties/{{ specialty.id }}" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-eye"></i>
                            </a>
                            <button type="button" class="btn btn-sm btn-outline-primary edit-specialty" data-id="{{ specialty.id }}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger delete-specialty" data-id="{{ specialty.id }}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Inline modals and scripts extracted from specialties.html to avoid missing includes -->
    <!-- Модальное окно для добавления/редактирования специальности -->
    <div class="modal fade" id="specialtyModal" tabindex="-1" aria-labelledby="specialtyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="specialtyModalLabel">Добавить специальность</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="specialty-form">
                        <input type="hidden" id="specialty-id">
                        <div class="mb-3">
                            <label for="specialty-name" class="form-label">Название</label>
                            <input type="text" class="form-control" id="specialty-name" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="specialty-active" checked>
                            <label class="form-check-label" for="specialty-active">Активна</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="save-specialty">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для подтверждения удаления -->
    <div class="modal fade" id="deleteSpecialtyModal" tabindex="-1" aria-labelledby="deleteSpecialtyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteSpecialtyModalLabel">Подтверждение удаления</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Вы уверены, что хотите удалить эту специальность?</p>
                    <p>Это действие нельзя отменить.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-specialty">Удалить</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Кнопка добавления
            document.getElementById('add-specialty-btn').addEventListener('click', function() {
                document.getElementById('specialtyModalLabel').textContent = 'Добавить специальность';
                document.getElementById('specialty-form').reset();
                document.getElementById('specialty-id').value = '';
                document.getElementById('specialty-active').checked = true;
                const modal = new bootstrap.Modal(document.getElementById('specialtyModal'));
                modal.show();
            });

            // Редактирование
            document.querySelectorAll('.edit-specialty').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const row = this.closest('tr');
                    const name = row.cells[1].textContent.trim();
                    const statusCell = row.cells[2].textContent.trim().toLowerCase();
                    const isActive = statusCell.includes('актив');

                    document.getElementById('specialtyModalLabel').textContent = 'Редактировать специальность';
                    document.getElementById('specialty-id').value = id;
                    document.getElementById('specialty-name').value = name;
                    document.getElementById('specialty-active').checked = isActive;

                    const modal = new bootstrap.Modal(document.getElementById('specialtyModal'));
                    modal.show();
                });
            });

            // Удаление
            document.querySelectorAll('.delete-specialty').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    document.getElementById('confirm-delete-specialty').setAttribute('data-id', id);
                    const modal = new bootstrap.Modal(document.getElementById('deleteSpecialtyModal'));
                    modal.show();
                });
            });

            // Подтверждение удаления
            document.getElementById('confirm-delete-specialty').addEventListener('click', async function() {
                const id = this.getAttribute('data-id');
                try {
                    const response = await authFetch(`/specialties/api/specialties/${id}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (!response.ok) throw new Error('Ошибка при удалении специальности');
                    bootstrap.Modal.getInstance(document.getElementById('deleteSpecialtyModal')).hide();
                    window.location.reload();
                } catch (error) {
                    console.error('Ошибка:', error);
                    alert('Произошла ошибка при удалении специальности');
                }
            });

            // Сохранение
            document.getElementById('save-specialty').addEventListener('click', async function() {
                const id = document.getElementById('specialty-id').value;
                const name = document.getElementById('specialty-name').value;
                const isActive = document.getElementById('specialty-active').checked;
                if (!name) { alert('Название специальности обязательно'); return; }
                const payload = { name, is_active: isActive };
                try {
                    let url = '/specialties/api/specialties';
                    let method = 'POST';
                    if (id) { url = `/specialties/api/specialties/${id}`; method = 'PUT'; }
                    const response = await authFetch(url, {
                        method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error('Ошибка при сохранении специальности');
                    bootstrap.Modal.getInstance(document.getElementById('specialtyModal')).hide();
                    window.location.reload();
                } catch (error) {
                    console.error('Ошибка:', error);
                    alert('Произошла ошибка при сохранении специальности');
                }
            });

            // Поиск
            document.getElementById('search-button').addEventListener('click', function() {
                const searchTerm = document.getElementById('search-specialty').value.toLowerCase();
                const rows = document.querySelectorAll('#specialties-table tr');
                rows.forEach(row => {
                    const name = row.cells[1].textContent.toLowerCase();
                    row.style.display = name.includes(searchTerm) ? '' : 'none';
                });
            });

            // Фильтр статуса
            document.getElementById('status-filter').addEventListener('change', function() {
                const status = this.value;
                const rows = document.querySelectorAll('#specialties-table tr');
                rows.forEach(row => {
                    if (!status) { row.style.display = ''; return; }
                    const statusCell = row.cells[2].textContent.trim().toLowerCase();
                    const isActive = statusCell.includes('активна');
                    row.style.display = (status === 'active' ? isActive : !isActive) ? '' : 'none';
                });
            });

            // Обновить
            document.getElementById('refresh-specialties').addEventListener('click', function() {
                window.location.reload();
            });
        });
    </script>
</div>

