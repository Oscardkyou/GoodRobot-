{# Partial for masters tab inside management.html #}
<div id="masters-tab-content">
    <!-- BEGIN masters content copied from masters.html (without extends/blocks) -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Управление мастерами</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="input-group me-2">
                <input type="text" class="form-control" id="masters-search-master" placeholder="Поиск мастера...">
                <button class="btn btn-outline-secondary" type="button" id="masters-search-button">
                    <i class="bi bi-search"></i>
                </button>
            </div>
            <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" id="masters-refresh-masters">Обновить</button>
                <button type="button" class="btn btn-sm btn-success" id="masters-add-master-btn">Добавить мастера</button>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Фильтры</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <select class="form-select" id="masters-status-filter">
                                <option value="">Все статусы</option>
                                <option value="active">Активные</option>
                                <option value="inactive">Заблокированные</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-primary" id="masters-apply-filters">Применить</button>
                            <button type="button" class="btn btn-outline-secondary" id="masters-reset-filters">Сбросить</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Telegram ID</th>
                    <th scope="col">Имя пользователя</th>
                    <th scope="col">ФИО</th>
                    <th scope="col">Телефон</th>
                    <th scope="col">Зоны обслуживания</th>
                    <th scope="col">Статус</th>
                    <th scope="col">Дата регистрации</th>
                    <th scope="col">Действия</th>
                </tr>
            </thead>
            <tbody id="masters-table">
                <tr>
                    <td colspan="9" class="text-center">Загрузка данных...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <nav aria-label="Навигация по страницам">
        <ul class="pagination justify-content-center" id="masters-pagination">
            <li class="page-item disabled">
                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Предыдущая</a>
            </li>
            <li class="page-item active"><a class="page-link" href="#">1</a></li>
            <li class="page-item">
                <a class="page-link" href="#">Следующая</a>
            </li>
        </ul>
    </nav>

    <!-- Модальное окно для блокировки/разблокировки мастера -->
    <div class="modal fade" id="masters-masterActionModal" tabindex="-1" aria-labelledby="masters-masterActionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="masters-masterActionModalLabel">Подтверждение действия</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="masters-masterActionModalBody">
                    Вы уверены, что хотите выполнить это действие?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="masters-confirmMasterAction">Подтвердить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для добавления мастера -->
    <div class="modal fade" id="masters-addMasterModal" tabindex="-1" aria-labelledby="masters-addMasterModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="masters-addMasterModalLabel">Добавить мастера</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="masters-add-master-form">
                        <div class="mb-3">
                            <label for="masters-master-telegram-id" class="form-label">Telegram ID</label>
                            <input type="number" class="form-control" id="masters-master-telegram-id" required>
                        </div>
                        <div class="mb-3">
                            <label for="masters-master-username" class="form-label">Имя пользователя</label>
                            <input type="text" class="form-control" id="masters-master-username" required>
                        </div>
                        <div class="mb-3">
                            <label for="masters-master-fullname" class="form-label">ФИО</label>
                            <input type="text" class="form-control" id="masters-master-fullname" required>
                        </div>
                        <div class="mb-3">
                            <label for="masters-master-phone" class="form-label">Телефон</label>
                            <input type="text" class="form-control" id="masters-master-phone" required>
                        </div>
                        <div class="mb-3">
                            <label for="masters-master-password" class="form-label">Пароль</label>
                            <input type="password" class="form-control" id="masters-master-password" required>
                        </div>
                        <div class="mb-3">
                            <label for="masters-master-zones" class="form-label">Зоны обслуживания (через запятую)</label>
                            <input type="text" class="form-control" id="masters-master-zones" placeholder="1,2,3">
                        </div>
                        <div class="mb-3">
                            <label for="masters-master-specialties" class="form-label">Специальности</label>
                            <select class="form-select" id="masters-master-specialties" multiple>
                                <!-- Специальности будут загружены динамически -->
                            </select>
                            <div class="form-text">Удерживайте Ctrl (или Command на Mac) для выбора нескольких специальностей</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-success" id="masters-save-master">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Inline script (extracted from masters.html) with ID namespacing to avoid collisions -->
    <script>
        let currentPage = 1;
        const pageSize = 10;
        let totalMasters = 0;
        let currentAction = null;
        let currentMasterId = null;

        // Загрузка мастеров
        async function loadMasters(page = 1, filters = {}) {
            try {
                const token = localStorage.getItem('token');
                let url = `/masters/api?skip=${(page - 1) * pageSize}&limit=${pageSize}`;

                if (filters.status) url += `&is_active=${filters.status === 'active'}`;
                if (filters.search) url += `&search=${encodeURIComponent(filters.search)}`;

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const masters = await response.json();
                    const tbody = document.getElementById('masters-table');
                    tbody.innerHTML = '';

                    if (masters.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="9" class="text-center">Нет данных</td></tr>';
                        updatePagination(page); // обновим пагинацию даже при пустом наборе
                        return;
                    }

                    for (const master of masters) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${master.id}</td>
                            <td>${master.telegram_id}</td>
                            <td>${master.username || '-'}</td>
                            <td>${master.full_name || '-'}</td>
                            <td>${master.phone || '-'}</td>
                            <td>${master.zones ? master.zones.join(', ') : '-'}</td>
                            <td>
                                <span class="badge bg-${master.is_active ? 'success' : 'danger'}">
                                    ${master.is_active ? 'Активен' : 'Заблокирован'}
                                </span>
                            </td>
                            <td>${new Date(master.created_at).toLocaleDateString()}</td>
                            <td>
                                <div class="btn-group">
                                    <a href="/users/${master.id}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    ${master.is_active ? 
                                        `<button class="btn btn-sm btn-outline-danger block-master" data-id="${master.id}">
                                            <i class="bi bi-lock"></i>
                                        </button>` : 
                                        `<button class="btn btn-sm btn-outline-success unblock-master" data-id="${master.id}">
                                            <i class="bi bi-unlock"></i>
                                        </button>`
                                    }
                                    <button class="btn btn-sm btn-outline-danger delete-master" data-id="${master.id}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    }

                    // Кнопки действий
                    document.querySelectorAll('.block-master').forEach(button => {
                        button.addEventListener('click', function() {
                            showMasterActionModal('block', this.dataset.id);
                        });
                    });

                    document.querySelectorAll('.unblock-master').forEach(button => {
                        button.addEventListener('click', function() {
                            showMasterActionModal('unblock', this.dataset.id);
                        });
                    });

                    document.querySelectorAll('.delete-master').forEach(button => {
                        button.addEventListener('click', function() {
                            showMasterActionModal('delete', this.dataset.id);
                        });
                    });

                    // Обновляем пагинацию
                    updatePagination(page);
                } else {
                    console.error('Ошибка загрузки мастеров');
                }
            } catch (error) {
                console.error('Ошибка:', error);
            }
        }

        function updatePagination(currentPage) {
            const totalPages = Math.ceil(totalMasters / pageSize) || 1;
            const pagination = document.getElementById('masters-pagination');
            if (!pagination) return;
            pagination.innerHTML = '';

            const prevItem = document.createElement('li');
            prevItem.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            const prevLink = document.createElement('a');
            prevLink.className = 'page-link';
            prevLink.href = '#';
            prevLink.textContent = 'Предыдущая';
            if (currentPage > 1) {
                prevLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    loadMasters(currentPage - 1, getFilters());
                });
            }
            prevItem.appendChild(prevLink);
            pagination.appendChild(prevItem);

            for (let i = 1; i <= totalPages; i++) {
                const pageItem = document.createElement('li');
                pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
                const pageLink = document.createElement('a');
                pageLink.className = 'page-link';
                pageLink.href = '#';
                pageLink.textContent = i;
                pageLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    loadMasters(i, getFilters());
                });
                pageItem.appendChild(pageLink);
                pagination.appendChild(pageItem);
            }

            const nextItem = document.createElement('li');
            nextItem.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            const nextLink = document.createElement('a');
            nextLink.className = 'page-link';
            nextLink.href = '#';
            nextLink.textContent = 'Следующая';
            if (currentPage < totalPages) {
                nextLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    loadMasters(currentPage + 1, getFilters());
                });
            }
            nextItem.appendChild(nextLink);
            pagination.appendChild(nextItem);
        }

        function getFilters() {
            return {
                status: document.getElementById('masters-status-filter').value,
                search: document.getElementById('masters-search-master').value
            };
        }

        function showMasterActionModal(action, masterId) {
            const modal = new bootstrap.Modal(document.getElementById('masters-masterActionModal'));
            const modalBody = document.getElementById('masters-masterActionModalBody');

            currentAction = action;
            currentMasterId = masterId;

            if (action === 'block') {
                modalBody.textContent = `Вы уверены, что хотите заблокировать мастера #${masterId}?`;
            } else if (action === 'unblock') {
                modalBody.textContent = `Вы уверены, что хотите разблокировать мастера #${masterId}?`;
            } else if (action === 'delete') {
                modalBody.textContent = `Вы уверены, что хотите удалить мастера #${masterId}? Это действие нельзя отменить.`;
            }

            modal.show();
        }

        async function performMasterAction() {
            try {
                const token = localStorage.getItem('token');
                let url = `/masters/api/${currentMasterId}`;
                let method = 'POST';

                if (currentAction === 'delete') {
                    method = 'DELETE';
                } else {
                    url += `/${currentAction}`;
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('masters-masterActionModal'));
                    modal.hide();
                    loadMasters(currentPage, getFilters());
                } else {
                    console.error('Ошибка выполнения действия');
                }
            } catch (error) {
                console.error('Ошибка:', error);
            }
        }

        async function loadSpecialties() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/specialties/api', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const specialties = await response.json();
                    const selectElement = document.getElementById('masters-master-specialties');
                    selectElement.innerHTML = '';

                    for (const specialty of specialties) {
                        if (specialty.is_active) {
                            const option = document.createElement('option');
                            option.value = specialty.id;
                            option.textContent = specialty.name;
                            selectElement.appendChild(option);
                        }
                    }
                } else {
                    console.error('Ошибка загрузки специальностей');
                }
            } catch (error) {
                console.error('Ошибка:', error);
            }
        }

        async function addMaster() {
            try {
                const token = localStorage.getItem('token');
                const telegramId = document.getElementById('masters-master-telegram-id').value;
                const username = document.getElementById('masters-master-username').value;
                const fullName = document.getElementById('masters-master-fullname').value;
                const phone = document.getElementById('masters-master-phone').value;
                const password = document.getElementById('masters-master-password').value;
                const zonesInput = document.getElementById('masters-master-zones').value;

                const specialtiesSelect = document.getElementById('masters-master-specialties');
                const selectedSpecialties = Array.from(specialtiesSelect.selectedOptions).map(option => parseInt(option.value));

                const zones = zonesInput ? zonesInput.split(',').map(zone => parseInt(zone.trim())) : [];

                if (!telegramId || isNaN(parseInt(telegramId))) {
                    alert('Укажите корректный Telegram ID (число)');
                    return;
                }

                const response = await fetch('/masters/api', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        telegram_id: parseInt(telegramId),
                        username: username,
                        full_name: fullName,
                        phone: phone,
                        password: password,
                        zones: zones,
                        role: 'master',
                        is_active: true,
                        specialty_ids: selectedSpecialties
                    })
                });

                if (response.ok) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('masters-addMasterModal'));
                    modal.hide();
                    document.getElementById('masters-add-master-form').reset();
                    loadMasters(1, getFilters());
                } else {
                    console.error('Ошибка добавления мастера');
                    let message = 'Ошибка добавления мастера';
                    try {
                        const data = await response.json();
                        if (data && data.detail) message = data.detail;
                    } catch (e) {
                        const text = await response.text();
                        if (text) message = text;
                    }
                    alert(message);
                }
            } catch (error) {
                console.error('Ошибка:', error);
            }
        }

        // Инициализация после загрузки страницы
        document.addEventListener('DOMContentLoaded', function() {
            loadMasters();

            document.getElementById('masters-refresh-masters').addEventListener('click', function() {
                loadMasters(currentPage, getFilters());
            });

            document.getElementById('masters-apply-filters').addEventListener('click', function() {
                loadMasters(1, getFilters());
            });

            document.getElementById('masters-reset-filters').addEventListener('click', function() {
                document.getElementById('masters-status-filter').value = '';
                document.getElementById('masters-search-master').value = '';
                loadMasters(1, {});
            });

            document.getElementById('masters-search-button').addEventListener('click', function() {
                loadMasters(1, getFilters());
            });

            document.getElementById('masters-search-master').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadMasters(1, getFilters());
                }
            });

            document.getElementById('masters-confirmMasterAction').addEventListener('click', performMasterAction);

            document.getElementById('masters-add-master-btn').addEventListener('click', function() {
                loadSpecialties();
                const modal = new bootstrap.Modal(document.getElementById('masters-addMasterModal'));
                modal.show();
            });

            document.getElementById('masters-save-master').addEventListener('click', addMaster);

            document.getElementById('masters-master-phone').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');

                if (value.startsWith('7')) {
                    value = value.substring(1);
                }

                if (value.length > 0) {
                    if (value.length <= 3) {
                        value = `+7 (${value}`;
                    } else if (value.length <= 6) {
                        value = `+7 (${value.slice(0, 3)}) ${value.slice(3)}`;
                    } else if (value.length <= 8) {
                        value = `+7 (${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6)}`;
                    } else {
                        value = `+7 (${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6, 8)}-${value.slice(8, 10)}`;
                    }
                }

                e.target.value = value;
            });
        });
    </script>
</div>
